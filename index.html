<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Management Application</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root {
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --primary-text-color: #212529;
            --secondary-text-color: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-bg-faded: #cfe2ff;
            --accent-text-dark: #003d80;
            --danger-color: #dc3545;
            --danger-dark-color: #c82333;
            --danger-bg-faded: #f8d7da;
            --danger-text-dark: #721c24;
            --success-color: #28a745;
            --warning-color: #fd7e14;
            --warning-bg-faded: #fff3cd;
            --warning-text-dark: #856404;
            --paid-bg-color: #d4edda;
            --paid-text-color: #155724;
            --paid-marker-bg-color: #f1f3f5;
            --paid-marker-text-color: #868e96;
        }

        /* --- GLOBAL & RESET --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { font-size: 2rem; font-weight: 600; margin: 0; padding: 0; border: none; }
        h2 { font-size: 1.25rem; font-weight: 500; color: var(--secondary-text-color); margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Remove spinners from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            max-width: 1400px;
            margin: 0 auto;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 0 0 auto;
            position: sticky;
            top: 20px;
        }

        .main-container {
            flex: 2;
            width: 100%;
            max-width: 900px;
            margin: 0;
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- CALENDAR --- */
        .calendar-container {
            flex: 0 0 auto;
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-header h2 { font-size: 2rem; font-weight: 600; color: var(--primary-text-color); text-transform: none; }

        .calendar-header button {
            background: none;
            border: 1px solid transparent;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
            color: var(--secondary-text-color);
        }
        .calendar-header button:hover { background-color: #f8f9fa; border-color: var(--border-color); color: var(--primary-text-color); }

        .calendar-weekdays, .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 72px);
            text-align: center;
            gap: 5px;
        }

        .calendar-weekdays div { font-weight: 600; font-size: 0.8rem; color: var(--secondary-text-color); padding-bottom: 0.5rem; }

        .calendar-day {
            height: 72px;
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.8rem;
            transition: background-color 0.2s;
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .calendar-day.has-events { background-color: var(--paid-bg-color); border-color: var(--paid-text-color); cursor: pointer; }
        .calendar-day.has-events:hover { background-color: #c3e6cb; }
        .calendar-day.has-paid-events { background-color: var(--paid-marker-bg-color); border-color: var(--paid-marker-text-color); cursor: pointer; }
        .calendar-day.has-paid-events:hover { background-color: #e9ecef; }
        .calendar-day.not-current-month .day-number { color: #ced4da; }
        .day-number { font-weight: 500; margin-bottom: 4px; }
        .calendar-day.has-events .day-number { color: var(--paid-text-color); }
        .calendar-day.has-paid-events .day-number { color: var(--paid-marker-text-color); }

        .billing-events { display: flex; justify-content: center; align-items: center; flex-grow: 1; }
        .billing-event, .paid-event {
            background-color: transparent;
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0;
            border-radius: 0;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .billing-event { color: var(--paid-text-color); }
        .paid-event { color: var(--paid-marker-text-color); }

        /* --- OVERVIEW --- */
        .overview-container {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .overview-container h2 {
            margin: 0 0 1rem 0;
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-text-color);
            text-transform: none;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .overview-section { margin-bottom: 1.5rem; }
        .overview-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary-text-color);
            margin: 0 0 0.75rem 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overview-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f3f5;
        }
        .overview-item span:last-child { font-weight: 500; color: var(--primary-text-color); }
        .overview-totals { padding-top: 1rem; margin-top: 1rem; border-top: 1px solid var(--border-color); }
        .overview-item.total { font-size: 1rem; font-weight: 600; color: var(--primary-text-color); border-bottom: none; }
        .overview-item.total span:last-child { font-size: 1.1rem; }

        /* --- TENANT LIST & ITEMS --- */
        .floor-container { margin-bottom: 2.5rem; }
        .floor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .floor-header:hover { background-color: #f8f9fa; }

        .tenant-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .tenant-item { border-bottom: 1px solid var(--border-color); }
        .tenant-item:last-child { border-bottom: none; }

        .tenant-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .tenant-summary:hover, .tenant-item.expanded > .tenant-summary { background-color: #f6f7f9; }

        .tenant-details { display: flex; flex-direction: column; }
        .tenant-name { font-weight: 500; font-size: 1rem; margin-bottom: 0.25rem; min-height: 1.2rem; }
        .tenant-unit { font-size: 0.875rem; color: var(--secondary-text-color); }

        .tenant-status-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 90px;
            text-align: center;
            box-sizing: border-box;
            border: 1px solid transparent;
        }
        .status-paid { background-color: var(--paid-bg-color); color: var(--paid-text-color); border-color: var(--paid-text-color); }
        .status-billing { background-color: var(--warning-bg-faded); color: var(--warning-text-dark); border-color: var(--warning-text-dark); }
        .status-overdue { background-color: var(--danger-bg-faded); color: var(--danger-text-dark); border-color: var(--danger-text-dark); }

        .invoice-indicator, .warning-indicator, .late-indicator {
            width: 20px;
            height: 20px;
            background-color: #adb5bd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }
        .invoice-indicator::after {
            content: ''; display: block; width: 5px; height: 9px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); margin-bottom: 2px;
        }
        .warning-indicator, .late-indicator { color: white; font-weight: 800; font-size: 14px; line-height: 1; }
        .warning-indicator::after { content: '!'; }
        .late-indicator::after { content: 'L'; }

        /* --- EXPANDED DETAILS --- */
        .tenant-expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background-color: #f6f7f9;
            padding: 0 1.25rem;
        }
        .tenant-item.expanded > .tenant-expanded-details {
            max-height: 600px;
            padding: 1.5rem 1.25rem;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            font-size: 0.875rem;
        }
        .details-section { display: flex; flex-direction: column; gap: 0.5rem; }
        .details-section strong { color: var(--primary-text-color); font-weight: 500; margin-bottom: 0.25rem; }
        .details-section span { color: var(--secondary-text-color); }
        .details-section .expiring-date { color: var(--danger-color); }

        .details-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .action-buttons-left, .action-buttons-right { display: flex; gap: 0.5rem; }

        /* --- BUTTONS --- */
        button { font-family: inherit; }
        
        #set-rate-btn, #modal-renew-btn, #add-section-btn, .action-buttons-left button, .action-buttons-right button {
            background-color: #ffffff;
            border: 1px solid var(--secondary-text-color);
            color: var(--secondary-text-color);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            min-width: 100px;
            text-align: center;
        }
        #set-rate-btn:hover, #modal-renew-btn:hover, .action-buttons-left button:hover, .action-buttons-right button:hover {
            background-color: #f8f9fa;
            color: var(--primary-text-color);
            border-color: var(--primary-text-color);
        }
        
        .action-buttons-left .bill-btn { background-color: var(--warning-bg-faded); color: var(--warning-text-dark); border: 1px solid var(--warning-text-dark); }
        .action-buttons-left .bill-btn:hover { background-color: #ffeeba; }
        .action-buttons-right .paid-btn { background-color: var(--paid-bg-color); color: var(--paid-text-color); border: 1px solid var(--paid-text-color); }
        .action-buttons-right .paid-btn:hover { background-color: #c3e6cb; }
        .action-buttons-left .dlt-btn { background-color: var(--danger-bg-faded); color: var(--danger-text-dark); border: 1px solid var(--danger-text-dark); }
        .action-buttons-left .dlt-btn:hover { background-color: #f5c6cb; }

        #add-section-btn { width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 1rem; border-radius: 8px; }
        #add-section-btn:hover { background-color: #f8f9fa; color: var(--accent-color); border-color: var(--accent-color); }
        #add-section-btn:disabled { cursor: wait; background-color: #f8f9fa; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%; max-width: 500px;
            transition: max-width 0.3s ease;
        }
        .modal-content.history-modal { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-content h3 { font-size: 1.5rem; font-weight: 600; margin: 0; }
        #modal-inputs { max-height: 60vh; overflow-y: auto; padding-right: 1rem; margin-right: -1rem; }
        
        .modal-confirmation-text { font-size: 1rem; line-height: 1.5; color: var(--secondary-text-color); margin-bottom: 1rem; }
        .input-group { margin-bottom: 1rem; }
        .input-row { display: flex; gap: 1rem; }
        .input-row .input-group { flex: 1; min-width: 0; }
        .modal-spacer { height: 4rem; }

        .input-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--secondary-text-color); }
        
        .modal-input {
            width: 100%; padding: 0.75rem;
            border: 1px solid var(--border-color); border-radius: 8px;
            font-family: inherit; font-size: 1rem; box-sizing: border-box;
        }
        .modal-input:focus { outline: none; }
        .modal-input.is-invalid { border-color: var(--danger-color); }
        .invalid-feedback { color: var(--danger-color); font-size: 0.8rem; margin-top: 0.25rem; display: none; }
        .modal-input.is-invalid + .invalid-feedback { display: block; }

        .radio-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; font-weight: 400; }
        input[type="radio"]:focus { outline: none; }

        /* Custom inputs */
        .modal-input.vehicle-input { padding-right: 2.5rem; }
        .fee-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; position: relative; }
        .fee-desc-input { flex: 2; padding-left: 2.5rem; }
        .fee-amount-input { flex: 1; padding-right: 2.5rem; }
        
        .vehicle-input-group { position: relative; display: flex; align-items: center; margin-bottom: -1px; }
        #vehicle-input-container .modal-input { border-radius: 0; }
        #vehicle-input-container .vehicle-input-group:first-child .modal-input { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        #vehicle-input-container .vehicle-input-group:last-child .modal-input { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .vehicle-input-group input { flex-grow: 1; }

        #add-vehicle-btn, #add-fee-btn { font-size: 0.875rem; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 0.25rem; font-weight: 500; }
        
        .remove-vehicle-btn, .remove-fee-btn, .pin-fee-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; padding: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .remove-vehicle-btn, .remove-fee-btn { right: 10px; width: 24px; height: 24px; font-size: 1.5rem; color: var(--secondary-text-color); line-height: 1; }
        .pin-fee-btn { left: 10px; width: 24px; height: 24px; color: #d1d5db; transition: all 0.2s; }
        .pin-fee-btn svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }
        .pin-fee-btn.active { color: var(--accent-color); }
        .pin-fee-btn.active svg { fill: currentColor; }
        .pin-fee-btn:hover { color: var(--secondary-text-color); }
        .pin-fee-btn.active:hover { color: var(--accent-text-dark); }

        /* Stepper */
        .stepper-container { display: flex; align-items: stretch; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; position: relative; }
        .stepper-container .modal-input { border: none; border-radius: 0; text-align: center; flex-grow: 1; padding-left: 1rem; padding-right: 0.5rem; }
        .stepper-btns { display: flex; flex-direction: column; width: 2rem; justify-content: center; padding-right: 5px; }
        .stepper-btn { flex: 1; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--secondary-text-color); transition: color 0.2s; padding: 0; }
        .stepper-btn:hover { color: var(--primary-text-color); }
        .stepper-btn svg { width: 16px; height: 16px; stroke-width: 2.5; pointer-events: none; }

        .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        .modal-btn { padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; min-width: 90px; text-align: center; }
        .modal-btn-primary { background-color: var(--accent-bg-faded); color: var(--accent-text-dark); border: 1px solid var(--accent-text-dark); }
        .modal-btn-primary:hover { background-color: #b6d4fe; }
        .modal-btn-primary:disabled { background-color: #e9ecef; color: #adb5bd; border-color: var(--border-color); cursor: not-allowed; opacity: 1; }
        .modal-btn-secondary { background-color: #ffffff; color: var(--secondary-text-color); border: 1px solid var(--secondary-text-color); }
        .modal-btn-secondary:hover { background-color: #f8f9fa; }

        /* --- CONTEXT MENU --- */
        .context-menu {
            position: absolute; z-index: 1001;
            background-color: var(--card-background);
            border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0; min-width: 150px;
        }
        .context-menu-item { padding: 0.5rem 1rem; font-size: 0.9rem; color: var(--primary-text-color); cursor: pointer; transition: background-color 0.2s ease; }
        .context-menu-item:hover { background-color: #f8f9fa; }
        .context-menu-divider { height: 1px; background-color: var(--border-color); margin: 0.25rem 0; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1200px) {
            .app-container { flex-direction: column; align-items: center; }
            .left-column { width: 100%; max-width: 900px; box-sizing: border-box; position: static; }
            .calendar-container { width: 100%; }
            .main-container { max-width: 100%; }
        }

        /* Updated breakpoint to 1024px to capture tablets and landscape phones */
        @media (max-width: 1024px) {
            /* 1. iOS Safari does not support 'zoom'. 
               2. We use font-size: 9.5px (scaled down further) to simulate the scale.
               3. Buttons and sizing use 'em' so they scale relative to this font size.
            */
            body { 
                padding: 10px; 
                font-size: 9.5px; /* Reduced from 10.5px */
                -webkit-text-size-adjust: 100%; /* Prevent auto-enlarging text on rotate */
            }
            
            /* --- Layout Reordering & Visibility --- */
            .app-container { 
                flex-direction: column; 
            }

            /* Hide Calendar (Left Column) entirely */
            .left-column { 
                display: none !important; 
            }

            /* Move Main Container (Tenants) to Top and make Transparent */
            .main-container { 
                order: 1; 
                padding: 0; /* Remove padding */
                width: 100%;
                border: none !important;
                box-shadow: none !important;
                background-color: transparent !important; /* Transparent BG */
                margin-bottom: 20px;
            }

            /* --- Visibility Controls --- */
            /* Hide Overview completely */
            .overview-container { display: none !important; }
            
            /* Hide Global Actions & Headers */
            .header-actions, 
            #add-section-btn, 
            .context-menu,
            .main-header, /* Hide "Tenant Information" Title */
            .floor-header /* Hide "Floor X" Headers */ { 
                display: none !important; 
            }

            /* REMOVE SPACING BETWEEN SECTIONS */
            .floor-container {
                margin-bottom: 0 !important;
            }

            /* --- Tenant Actions --- */
            /* Show action container */
            .details-actions { 
                display: flex !important; 
                flex-direction: row; 
                justify-content: flex-end; 
                padding-top: 1rem; 
                margin-top: 1rem;
                gap: 0;
            }
            /* Hide specific action buttons (Edit, Bill, Delete, History) */
            .action-buttons-left { display: none !important; }
            /* Show right action buttons (Paid) */
            .action-buttons-right { 
                display: flex; 
                width: 100%; 
                justify-content: flex-end; 
            }
            /* Ensure Paid button is visible and sized proportionally */
            .paid-btn { 
                min-width: 70px;
                padding: 0.4em 0.8em; /* Use em to scale with font-size */
                font-size: 1.1em;
            }

            /* --- Component Styling --- */
            
            /* Revised: GRID Layout to force side-by-side on iPhone */
            .tenant-summary { 
                display: grid !important;
                grid-template-columns: 1fr auto !important; /* Left takes space, Right fits content */
                align-items: center !important;
                gap: 8px; 
                padding: 0.8rem 10px; /* Added 10px horizontal padding */
                background-color: transparent; 
                border-bottom: none !important; /* REMOVE DOUBLE BORDER (Fixes thick line) */
            }
            
            /* Clean up list borders for the "transparent" look */
            .tenant-list {
                border: none;
                border-radius: 0;
            }
            
            /* Ensure single clean border between items */
            .tenant-item {
                background-color: transparent; 
                border-bottom: 1px solid #e9ecef !important; /* Single 1px line */
            }

            /* Add border to the last item of a section so it separates from the next section */
            .tenant-item:last-child {
                border-bottom: 1px solid #e9ecef !important;
            }

            /* Truncate text and Fix Font Sizes */
            .tenant-summary .tenant-details {
                min-width: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* FORCE smaller fonts using em (relative to 9.5px body) instead of rem (relative to 16px root) */
            .tenant-name { 
                font-size: 1.2em !important; /* ~11.4px */
                font-weight: 600;
                margin-bottom: 0; /* Tighten spacing */
                min-height: 0; /* Remove spacer */
            }
            .tenant-unit { 
                font-size: 0.9em !important; /* ~8.55px */
                margin-top: 2px;
            }

            /* Fix expanded view font size to match mobile base size */
            .details-grid {
                font-size: 1em !important;
            }

            /* Ensure indicators align correctly in the grid cell */
            .tenant-summary > div:last-child {
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            /* Mobile-specific adjustments for indicators to be smaller */
            .invoice-indicator, .warning-indicator, .late-indicator {
                width: 14px;
                height: 14px;
                margin-right: 4px;
                font-size: 9px;
            }
            
            /* Adjust checkmark inside invoice indicator */
            .invoice-indicator::after {
                width: 2.5px;
                height: 5px;
                border-width: 0 1.5px 1.5px 0;
            }

            /* Tighter badges */
            .tenant-status-badge {
                padding: 0.25em 0.6em;
                min-width: 50px; /* Smaller min-width */
                font-size: 0.85em; /* Smaller font */
            }
            
            /* Fix clipping in expanded view by increasing max-height significantly for mobile */
            .tenant-item.expanded > .tenant-expanded-details {
                padding: 1rem 0.5rem;
                max-height: 1500px; 
            }

            #set-rate-btn, #modal-renew-btn { display: none !important; }
            .input-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Column: Calendar & Overview -->
        <div class="left-column">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <h2 id="calendar-month-year"></h2>
                    <button id="next-month-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="calendar-weekdays">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>

            <div class="overview-container">
                <h2 id="overview-header">Overview</h2>
                <div class="overview-section">
                    <h3>Income</h3>
                    <div class="overview-item"><span>Unit total:</span><span id="overview-income-unit">0.00 USD</span></div>
                    <div class="overview-item"><span>Parking total:</span><span id="overview-income-parking">0.00 USD</span></div>
                    <div class="overview-item"><span>Consumption total:</span><span id="overview-income-consumption">0.00 USD</span></div>
                    <div class="overview-item"><span>Other:</span><span id="overview-income-other">0.00 USD</span></div>
                </div>
                <div class="overview-section">
                    <h3 id="expense-header">Expense</h3>
                    <div class="overview-item"><span>Employee salary:</span><span id="overview-expense-salary">0.00 USD</span></div>
                    <div class="overview-item"><span>Maintenance:</span><span id="overview-expense-maintenance">0.00 USD</span></div>
                    <div class="overview-item"><span>Consumption cost:</span><span id="overview-expense-consumption-cost">0.00 USD</span></div>
                    <div class="overview-item"><span>Other:</span><span id="overview-expense-other">0.00 USD</span></div>
                </div>
                <div class="overview-totals">
                    <div class="overview-item total"><span>Total Profit:</span><span id="overview-total-profit">0.00 USD</span></div>
                    <div class="overview-item total"><span>Net Profit:</span><span id="overview-net-profit">0.00 USD</span></div>
                </div>
            </div>
        </div>

        <!-- Main Column: Tenant Information -->
        <div class="main-container">
            <div class="main-header">
                <h1>Tenant Information</h1>
                <div class="header-actions">
                    <button id="set-rate-btn">Set rate</button>
                </div>
            </div>
            <div id="sections-container"></div>
            <button id="add-section-btn">+ add section</button>
        </div>
    </div>

    <!-- Modals & Context Menu -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-renew-btn" style="display: none;">Renew</button>
            </div>
            <div id="modal-inputs"></div>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="modal-btn modal-btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="modal-overlay" style="display: flex; z-index: 2000; background-color: var(--background-color);">
        <div class="modal-content" style="max-width: 320px; text-align: center;">
            <h3 style="margin-bottom: 1.5rem;">Restricted Access</h3>
            <div class="input-group">
                <input type="password" id="login-pin" class="modal-input" placeholder="Enter PIN" style="text-align: center; letter-spacing: 5px; font-size: 1.2rem; margin-bottom: 1rem;" autocomplete="off">
            </div>
            <button id="login-btn" class="modal-btn modal-btn-primary" style="width: 100%; padding: 0.75rem;">Unlock Application</button>
            <p id="login-error" style="color: var(--danger-color); margin-top: 15px; font-size: 0.9rem; display: none;">Invalid PIN. Please try again.</p>
        </div>
    </div>

    <div id="context-menu" class="context-menu" style="display: none;"></div>

    <script>
        (function() {
            'use strict';

            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEV-P0u-4SYxhJdrKWMu4IcIUFzYGvW7MMYQHigrMN2dfsBSHz2iLbZl4xBFDGo8JM/exec";
            const SYNC_INTERVAL = 30000;

            const state = {
                pin: localStorage.getItem('tenant_app_pin') || "", // Load saved PIN
                isAuthenticated: false,
                rates: { electricity: 0.25, water: 1.0, parking: 50.0, lateFee: 5.0 },
                sections: [],
                archivedTenants: [],
                expenses: {},
                invoiceCounter: 1,
                logoUrl: "",
                defaultTenantState: {
                    name: '', phone: '', leaseStart: "", leaseEnd: "", tenure: "", currentBillingDate: "",
                    nationality: 'Local', idExpiry: '', passportExpiry: "", visaExpiry: "", 
                    vehicles: 0, waterPax: 0, customFees: [], elecPrev: "", elecCurrent: "", rent: "",
                    other: "", paymentHistory: [],
                    hasGeneratedInvoice: false
                },
                nextSectionId: 1,
                nextTenantId: 1,
                currentModalCallback: null,
                currentModalCancelCallback: null,
                currentlyExpandedTenantId: null,
                currentlyEditingTenantId: null,
                isModalOpen: false,
                isSaving: false,
                calendarDate: new Date(),
                tempCalendarData: { billing: {}, paid: {} },
            };

            const DOM = {};

            function cacheDOMElements() {
                const ids = [
                    'sections-container', 'add-section-btn', 'set-rate-btn', 'modal-overlay',
                    'modal-title', 'modal-renew-btn', 'modal-inputs', 'modal-save-btn',
                    'modal-cancel-btn', 'context-menu', 'calendar-grid', 'calendar-month-year',
                    'prev-month-btn', 'next-month-btn', 'overview-income-unit', 'overview-income-consumption',
                    'overview-income-parking', 'overview-income-other', 'overview-expense-salary',
                    'overview-expense-maintenance', 'overview-expense-consumption-cost', 'overview-expense-other',
                    'overview-total-profit', 'overview-net-profit', 'expense-header', 'overview-header',
                    'login-overlay', 'login-pin', 'login-btn', 'login-error' // Added Login Elements
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    DOM[camelCaseId] = document.getElementById(id);
                });
                DOM.modalInputsContainer = DOM.modalInputs;
            }

            async function sendActionToServer(action, payload) {
                state.isSaving = true;
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, payload, pin: state.pin }) // Send PIN with POST
                    });
                    const result = await response.json();
                    if (result.status === "success") {
                        return result.data;
                    } else {
                        console.error("Action failed:", result.message);
                        showError("Server Error: " + result.message);
                        return null;
                    }
                } catch (error) {
                    console.error("Error sending action to server:", error);
                    showError("Could not connect to the server. Please check your internet connection.");
                    return null;
                } finally {
                    state.isSaving = false;
                }
            }

            async function loadDataFromSheet() {
                if (state.isModalOpen || state.isSaving || !state.pin) return; // Don't load without PIN
                try {
                    // Send PIN with GET request
                    const response = await fetch(`${SCRIPT_URL}?pin=${encodeURIComponent(state.pin)}`);
                    if (!response.ok) throw new Error(`Failed to load data. Status: ${response.status}`);

                    const freshData = await response.json();
                    
                    // Check if backend returned an error (Invalid PIN)
                    if (freshData.status === 'error') {
                        throw new Error(freshData.message);
                    }

                    if (!freshData) {
                        console.warn("Received empty data from server.");
                        return;
                    }

                    // If we get here, authentication is successful
                    if (!state.isAuthenticated) {
                        state.isAuthenticated = true;
                        DOM.loginOverlay.style.display = 'none';
                        localStorage.setItem('tenant_app_pin', state.pin); // Save valid PIN
                    }

                    const currentDataSignature = JSON.stringify({
                        rates: state.rates, sections: state.sections, expenses: state.expenses,
                        archivedTenants: state.archivedTenants, invoiceCounter: state.invoiceCounter, logoUrl: state.logoUrl
                    });
                    const freshDataSignature = JSON.stringify(freshData);

                    if (currentDataSignature !== freshDataSignature) {
                        state.rates = freshData.rates && Object.keys(freshData.rates).length > 0 ? freshData.rates : state.rates;
                        state.sections = [];
                        state.expenses = freshData.expenses || {};
                        state.archivedTenants = freshData.archivedTenants || [];
                        state.invoiceCounter = freshData.invoiceCounter || 1;
                        state.logoUrl = freshData.logoUrl || "";

                        if (freshData.sections) {
                            state.sections = JSON.parse(JSON.stringify(freshData.sections));
                            state.sections.forEach(section => {
                                if (!section.tenants) section.tenants = [];
                                section.tenants.forEach(t => {
                                     if (typeof t.customFees === 'string') {
                                         try { t.customFees = JSON.parse(t.customFees); } catch (e) { t.customFees = []; }
                                     }
                                     if (!Array.isArray(t.customFees)) t.customFees = [];
                                     if (t.other > 0 && t.customFees.length === 0) {
                                         t.customFees.push({ description: "Miscellaneous", amount: parseFloat(t.other), isPinned: false });
                                     }
                                     if (Array.isArray(t.vehicles)) {
                                         t.vehicles = t.vehicles.length;
                                     } else {
                                         t.vehicles = parseInt(t.vehicles) || 0;
                                     }
                                     t.waterPax = parseInt(t.waterPax) || 0;
                                });
                            });
                        }

                        const allActiveTenantIds = state.sections.flatMap(s => s.tenants.map(t => t.id));
                        const allArchivedIds = state.archivedTenants.map(t => t.id);
                        state.nextTenantId = Math.max(0, ...allActiveTenantIds, ...allArchivedIds) + 1;

                        if (state.sections.length > 0) {
                            const allSectionIds = state.sections.map(s => s.id);
                            state.nextSectionId = Math.max(0, ...allSectionIds) + 1;
                        }
                        render();
                    }
                } catch (error) {
                    console.error("Sync Error:", error);
                    if (error.message === "Invalid Access PIN") {
                        state.isAuthenticated = false;
                        state.pin = "";
                        localStorage.removeItem('tenant_app_pin');
                        DOM.loginOverlay.style.display = 'flex';
                        DOM.loginError.textContent = "Invalid PIN. Please try again.";
                        DOM.loginError.style.display = 'block';
                    }
                }
            }

            function sanitizeDateString(dateStr) {
                if (!dateStr || typeof dateStr !== 'string') return "";
                return dateStr.split('T')[0];
            }

            function formatDate(isoString) {
                const cleanDateStr = sanitizeDateString(isoString);
                if (!cleanDateStr) return "";
                const parts = cleanDateStr.split('-');
                if (parts.length !== 3) return "";
                const [year, month, day] = parts;
                const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                return `${day} / ${months[parseInt(month, 10) - 1]} / ${year}`;
            }

            function isDateExpiring(isoDateString) {
                const cleanDateStr = sanitizeDateString(isoDateString);
                if (!cleanDateStr) return false;
                const date = new Date(cleanDateStr + 'T00:00:00Z');
                if (isNaN(date.getTime())) return false;
                const now = new Date();
                const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setUTCDate(today.getUTCDate() + 30);
                return date <= thirtyDaysFromNow && date >= today;
            }

            function addMonthsAndClamp(isoDate, months) {
                const cleanDateStr = sanitizeDateString(isoDate);
                if (!cleanDateStr) return "";
                const date = new Date(cleanDateStr + 'T00:00:00Z');
                if (isNaN(date.getTime())) return "";
                const originalDay = date.getUTCDate();
                date.setUTCDate(1);
                date.setUTCMonth(date.getUTCMonth() + months);
                const daysInNewMonth = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth() + 1, 0)).getUTCDate();
                date.setUTCDate(Math.min(originalDay, daysInNewMonth));
                return date.toISOString().split('T')[0];
            }

            const calculateNextBillingDate = (currentBillingISO) => addMonthsAndClamp(currentBillingISO, 1);
            const calculateFirstBillingDate = (leaseStart) => addMonthsAndClamp(leaseStart, 1);

            function calculateLeaseEndDate(leaseStart, tenure) {
                const tenureMonths = parseInt(tenure, 10);
                if (isNaN(tenureMonths) || !leaseStart) return null;
                return addMonthsAndClamp(leaseStart, tenureMonths);
            }

            function findTenant(tenantId) {
                for (const section of state.sections) {
                    const tenant = section.tenants.find(t => t.id === tenantId);
                    if (tenant) return { tenant, section };
                }
                return { tenant: null, section: null };
            }

            function getBillingInfo(tenant) {
                const elecCurrentNum = parseFloat(tenant.elecCurrent);
                const elecPrevNum = parseFloat(tenant.elecPrev || 0);
                const elecUsage = (!isNaN(elecCurrentNum) && elecCurrentNum >= elecPrevNum) ? elecCurrentNum - elecPrevNum : 0;
                const waterPax = parseInt(tenant.waterPax) || 0;
                const elecBilling = elecUsage * state.rates.electricity;
                const waterBilling = waterPax * state.rates.water;
                
                let vehicleCount = 0;
                if (Array.isArray(tenant.vehicles)) {
                    vehicleCount = tenant.vehicles.length;
                } else {
                    vehicleCount = parseInt(tenant.vehicles) || 0;
                }
                const parkingBilling = vehicleCount * state.rates.parking;
                const rent = parseFloat(tenant.rent || 0);
                let other = 0;
                if (Array.isArray(tenant.customFees) && tenant.customFees.length > 0) {
                    other = tenant.customFees.reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                } else if (tenant.other) {
                    other = parseFloat(tenant.other) || 0;
                }

                let lateFee = 0;
                let isLate = false;
                const today = new Date();
                const todayMidnight = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
                const billingDateStr = sanitizeDateString(tenant.currentBillingDate);
                if (billingDateStr) {
                    const billingDate = new Date(billingDateStr + 'T00:00:00Z');
                    const diffTime = todayMidnight - billingDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays >= 5) {
                        isLate = true;
                        lateFee = rent * ((state.rates.lateFee || 0) / 100);
                    }
                }
                const totalBilling = elecBilling + waterBilling + rent + other + parkingBilling + lateFee;
                return { elecBilling, waterBilling, parkingBilling, totalBilling, elecUsage, waterPax, other, vehicleCount, lateFee, isLate };
            }

            function getStatusInfo(tenant) {
                if (!tenant.name) return { badgeHTML: '', showActionButtons: false, showPaidButton: false, status: null };
                const now = new Date();
                const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
                const cleanDateStr = sanitizeDateString(tenant.currentBillingDate);
                const currentBillingDateObj = cleanDateStr ? new Date(cleanDateStr + 'T00:00:00Z') : null;
                
                let badgeText = 'Paid';
                let badgeClass = 'status-paid';
                let status = 'paid';
                let showActionButtons = false;

                if (currentBillingDateObj && !isNaN(currentBillingDateObj.getTime())) {
                    const diffDays = Math.ceil((currentBillingDateObj - today) / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) {
                        badgeText = 'Overdue'; badgeClass = 'status-overdue'; status = 'overdue'; showActionButtons = true;
                    } else if (diffDays <= 3) {
                        badgeText = 'Billing'; badgeClass = 'status-billing'; status = 'billing'; showActionButtons = true;
                    }
                }
                const badgeHTML = `<span class="tenant-status-badge ${badgeClass}">${badgeText}</span>`;
                const showPaidButton = showActionButtons && tenant.elecCurrent;
                return { badgeHTML, showActionButtons, showPaidButton, status };
            }

            function render() {
                DOM.sectionsContainer.innerHTML = '';
                state.sections.forEach(section => {
                    DOM.sectionsContainer.appendChild(createSectionElement(section));
                });
                renderCalendar();
                renderOverview();
            }

            function createSectionElement(section) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'floor-container';
                sectionDiv.dataset.sectionId = section.id;
                const header = document.createElement('div');
                header.className = 'floor-header';
                header.innerHTML = `<h2>${section.name}</h2>`;
                const tenantList = document.createElement('ul');
                tenantList.className = 'tenant-list';
                section.tenants.forEach(tenant => tenantList.appendChild(createTenantListItem(tenant)));
                sectionDiv.append(header, tenantList);
                return sectionDiv;
            }

            function createTenantListItem(tenant) {
                const statusInfo = getStatusInfo(tenant);
                const billingInfo = getBillingInfo(tenant);
                const listItem = document.createElement('li');
                listItem.className = 'tenant-item';
                listItem.dataset.tenantId = tenant.id;
                if (tenant.id === state.currentlyExpandedTenantId) listItem.classList.add('expanded');

                const hasExpiryWarning = isDateExpiring(tenant.leaseEnd) || isDateExpiring(tenant.idExpiry) || isDateExpiring(tenant.passportExpiry) || isDateExpiring(tenant.visaExpiry);

                listItem.innerHTML = `
                    <div class="tenant-summary">
                        <div class="tenant-details">
                            <span class="tenant-name">${tenant.name || 'No Name Assigned'}</span>
                            <span class="tenant-unit">Unit: ${tenant.unit}</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            ${tenant.hasGeneratedInvoice ? '<span class="invoice-indicator" title="Invoice Generated"></span>' : ''}
                            ${hasExpiryWarning ? '<span class="warning-indicator" title="Expiring Documents or Lease"></span>' : ''} 
                            ${billingInfo.isLate ? '<span class="late-indicator" title="Late Payment Fee Applied"></span>' : ''}
                            ${statusInfo.badgeHTML}
                        </div>
                    </div>
                    <div class="tenant-expanded-details"></div>`;

                if (tenant.id === state.currentlyExpandedTenantId) {
                    const expandedContent = createTenantExpandedDetails(tenant, billingInfo, statusInfo);
                    listItem.querySelector('.tenant-expanded-details').appendChild(expandedContent);
                }
                return listItem;
            }

            function createTenantExpandedDetails(tenant, billingInfo, statusInfo) {
                const { elecBilling, waterBilling, parkingBilling, totalBilling, other, vehicleCount, waterPax, lateFee } = billingInfo;
                const { showActionButtons, showPaidButton } = statusInfo;
                const fragment = document.createDocumentFragment();
                const grid = document.createElement('div');
                grid.className = 'details-grid';
                const leaseEndClass = isDateExpiring(tenant.leaseEnd) ? 'expiring-date' : '';
                const idExpiryClass = isDateExpiring(tenant.idExpiry) ? 'expiring-date' : '';
                const passportExpiryClass = isDateExpiring(tenant.passportExpiry) ? 'expiring-date' : '';
                const visaExpiryClass = isDateExpiring(tenant.visaExpiry) ? 'expiring-date' : '';
                let documentDetails = tenant.nationality === 'Local' ?
                    `<span class="${idExpiryClass}">ID Expiry: ${formatDate(tenant.idExpiry)}</span>` :
                    `<span class="${passportExpiryClass}">Passport Ex: ${formatDate(tenant.passportExpiry)}</span><span class="${visaExpiryClass}">Visa Ex: ${formatDate(tenant.visaExpiry)}</span>`;
                const contactDetails = `<span>Phone: ${tenant.phone || ''}</span>`;
                const vehicleListHTML = `<span>Count: ${vehicleCount}</span>`;
                
                let otherFeesHTML = '';
                if (Array.isArray(tenant.customFees) && tenant.customFees.length > 0) {
                      otherFeesHTML = tenant.customFees.map(f => `${f.description}: $${f.amount}`).join('<br>');
                } else if (other > 0) {
                      otherFeesHTML = 'Miscellaneous';
                }
                const rentDisplay = tenant.rent ? `${tenant.rent} USD ${lateFee > 0 ? `(+ ${lateFee.toFixed(2)} Late fee)` : ''}` : '';

                grid.innerHTML = `
                    <div class="details-section"><strong>Lease</strong><span>Start: ${formatDate(tenant.leaseStart)}</span><span class="${leaseEndClass}">End: ${formatDate(tenant.leaseEnd)}</span><span>Tenure: ${tenant.tenure ? tenant.tenure + ' month' : ''}</span></div>
                    <div class="details-section"><strong>Documents</strong>${documentDetails}</div>
                    <div class="details-section"><strong>Contact</strong>${contactDetails}</div>
                    <div class="details-section"><strong>Vehicles</strong>${vehicleListHTML}<span>Billing: ${vehicleCount > 0 ? parkingBilling.toFixed(2) + ' USD' : '0.00 USD'}</span></div>
                    <div class="details-section"><strong>Electricity Usage</strong><span>Previous: ${tenant.elecPrev ? tenant.elecPrev + ' Kwh' : ''}</span><span>New: ${tenant.elecCurrent ? tenant.elecCurrent + ' Kwh' : ''}</span><span>Billing: ${tenant.elecCurrent ? elecBilling.toFixed(2) + ' USD' : ''}</span></div>
                    <div class="details-section"><strong>Water Usage</strong><span>Pax: ${waterPax}</span><span>Billing: ${waterBilling.toFixed(2) + ' USD'}</span></div>
                    <div class="details-section"><strong>Payment</strong><span>Billing Date: ${formatDate(tenant.currentBillingDate)}</span><span>Rent: ${rentDisplay}</span><span>Other: ${other ? other.toFixed(2) + ' USD' : ''}</span><strong>Total billing: ${totalBilling > 0 ? totalBilling.toFixed(2) + ' USD' : ''}</strong></div>
                `;
                fragment.appendChild(grid);

                const actions = document.createElement('div');
                actions.className = 'details-actions';
                const leftButtons = document.createElement('div');
                leftButtons.className = 'action-buttons-left';
                leftButtons.innerHTML = `<button class="dlt-btn">End lease</button><button class="edt-btn">Edit</button>`;
                if (tenant.paymentHistory?.length > 0) leftButtons.innerHTML += '<button class="history-btn">History</button>';
                if (showActionButtons) leftButtons.innerHTML += '<button class="bill-btn">Bill</button>';
                const rightButtons = document.createElement('div');
                rightButtons.className = 'action-buttons-right';
                if (showPaidButton) rightButtons.innerHTML = '<button class="paid-btn">Paid</button>';
                actions.append(leftButtons, rightButtons);
                fragment.appendChild(actions);
                return fragment;
            }

            function renderOverview() {
                const date = state.calendarDate;
                const year = date.getFullYear();
                const month = date.getMonth();
                let totals = { incomeUnit: 0, incomeConsumption: 0, incomeParking: 0, incomeOther: 0 };
                const allTenantsForPayments = [...state.sections.flatMap(s => s.tenants), ...state.archivedTenants];

                allTenantsForPayments.forEach(tenant => {
                    (tenant.paymentHistory || []).forEach(entry => {
                        const paidDate = new Date(sanitizeDateString(entry.paidOn) + 'T00:00:00Z');
                        if (paidDate.getUTCFullYear() === year && paidDate.getUTCMonth() === month) {
                            totals.incomeUnit += entry.rent || 0;
                            totals.incomeParking += entry.parking || 0;
                            totals.incomeOther += entry.other || 0;
                            const elecUsage = parseFloat(entry.elecUsage) || 0;
                            const waterPax = parseFloat(entry.waterPax) || 0;
                            totals.incomeConsumption += (elecUsage * state.rates.electricity) + (waterPax * state.rates.water);
                        }
                    });
                });

                const expenseKey = `${year}-${month + 1}`;
                const currentExpenses = state.expenses[expenseKey] || { salary: 0, maintenance: 0, consumptionCost: 0, other: 0 };
                const totalIncome = Object.values(totals).reduce((sum, val) => sum + val, 0);
                const totalExpense = Object.values(currentExpenses).reduce((sum, val) => sum + val, 0);
                const totalProfit = totalIncome;
                const netProfit = totalIncome - totalExpense;

                DOM.overviewIncomeUnit.textContent = `${totals.incomeUnit.toFixed(2)} USD`;
                DOM.overviewIncomeConsumption.textContent = `${totals.incomeConsumption.toFixed(2)} USD`;
                DOM.overviewIncomeParking.textContent = `${totals.incomeParking.toFixed(2)} USD`;
                DOM.overviewIncomeOther.textContent = `${totals.incomeOther.toFixed(2)} USD`;
                DOM.overviewExpenseSalary.textContent = `${(currentExpenses.salary || 0).toFixed(2)} USD`;
                DOM.overviewExpenseMaintenance.textContent = `${(currentExpenses.maintenance || 0).toFixed(2)} USD`;
                DOM.overviewExpenseConsumptionCost.textContent = `${(currentExpenses.consumptionCost || 0).toFixed(2)} USD`;
                DOM.overviewExpenseOther.textContent = `${(currentExpenses.other || 0).toFixed(2)} USD`;
                DOM.overviewTotalProfit.textContent = `${totalProfit.toFixed(2)} USD`;
                DOM.overviewNetProfit.textContent = `${netProfit.toFixed(2)} USD`;
            }

            function renderCalendar() {
                const date = state.calendarDate;
                const year = date.getFullYear();
                const month = date.getMonth();
                DOM.calendarMonthYear.textContent = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                DOM.calendarGrid.innerHTML = '';
                state.tempCalendarData = { billing: {}, paid: {} };
                const activeTenants = state.sections.flatMap(s => s.tenants);
                const allTenantsForPayments = [...activeTenants, ...state.archivedTenants];
                activeTenants.forEach(tenant => {
                    const cleanDateStr = sanitizeDateString(tenant.currentBillingDate);
                    if (cleanDateStr) {
                        const billingDate = new Date(cleanDateStr + 'T00:00:00Z');
                        if (billingDate.getUTCFullYear() === year && billingDate.getUTCMonth() === month) {
                            const day = billingDate.getUTCDate();
                            if (!state.tempCalendarData.billing[day]) state.tempCalendarData.billing[day] = [];
                            state.tempCalendarData.billing[day].push({ tenant });
                        }
                    }
                });
                allTenantsForPayments.forEach(tenant => {
                    (tenant.paymentHistory || []).forEach(entry => {
                        const cleanDateStr = sanitizeDateString(entry.paidOn);
                        if (cleanDateStr) {
                            const paidDate = new Date(cleanDateStr + 'T00:00:00Z');
                            if (paidDate.getUTCFullYear() === year && paidDate.getUTCMonth() === month) {
                                const day = paidDate.getUTCDate();
                                if (!state.tempCalendarData.paid[day]) state.tempCalendarData.paid[day] = [];
                                state.tempCalendarData.paid[day].push({ tenant, entry });
                            }
                        }
                    });
                });
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const gridFragment = document.createDocumentFragment();
                let cellCount = 0;
                for (let i = 0; i < firstDayOfMonth; i++) {
                    gridFragment.appendChild(document.createElement('div')).className = 'calendar-day not-current-month';
                    cellCount++;
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    dayCell.innerHTML = `<div class="day-number">${i}</div>`;
                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'billing-events';
                    if (state.tempCalendarData.billing[i]?.length) {
                        dayCell.classList.add('has-events');
                        dayCell.dataset.day = i;
                        dayCell.dataset.type = 'billing';
                        const dailyTotal = state.tempCalendarData.billing[i].reduce((sum, item) => sum + getBillingInfo(item.tenant).totalBilling, 0);
                        if (dailyTotal > 0) eventsContainer.innerHTML = `<div class="billing-event">+${Math.round(dailyTotal)}</div>`;
                    } else if (state.tempCalendarData.paid[i]?.length) {
                        dayCell.classList.add('has-paid-events');
                        dayCell.dataset.day = i;
                        dayCell.dataset.type = 'paid';
                        const dailyTotalPaid = state.tempCalendarData.paid[i].reduce((sum, item) => sum + item.entry.totalPaid, 0);
                        if (dailyTotalPaid > 0) eventsContainer.innerHTML = `<div class="paid-event">+${Math.round(dailyTotalPaid)}</div>`;
                    }
                    if (eventsContainer.hasChildNodes()) dayCell.appendChild(eventsContainer);
                    gridFragment.appendChild(dayCell);
                    cellCount++;
                }
                while (cellCount % 7 !== 0) {
                    gridFragment.appendChild(document.createElement('div')).className = 'calendar-day not-current-month';
                    cellCount++;
                }
                DOM.calendarGrid.appendChild(gridFragment);
            }

            let currentValidationHandler = null;

            function showModal(config) {
                state.isModalOpen = true;
                if (currentValidationHandler) {
                    DOM.modalInputsContainer.removeEventListener('input', currentValidationHandler);
                    currentValidationHandler = null;
                }
                const { title, fields = [], initialValues = {}, onSave, onCancel, isConfirmation = false, confirmationText = "", isEdit = false, isDelete = false, saveButtonText = "Save", requiredFields = [], validationRules = [] } = config;

                DOM.modalTitle.textContent = title;
                DOM.modalInputsContainer.innerHTML = '';
                DOM.modalRenewBtn.style.display = isEdit ? 'block' : 'none';
                DOM.modalCancelBtn.style.display = 'inline-block';
                const modalContent = DOM.modalOverlay.querySelector('.modal-content');
                modalContent.classList.toggle('history-modal', !!config.isHistory);

                if (isConfirmation) {
                    DOM.modalSaveBtn.disabled = false;
                    DOM.modalInputsContainer.innerHTML = `<div class="modal-confirmation-text">${confirmationText}</div>`;
                    DOM.modalSaveBtn.textContent = saveButtonText || "Confirm";
                    if (isDelete) {
                        const input = document.createElement('input');
                        input.type = 'text'; input.className = 'modal-input'; input.placeholder = "Type 'confirm' to proceed";
                        DOM.modalInputsContainer.appendChild(input);
                        DOM.modalSaveBtn.textContent = "Proceed"; DOM.modalSaveBtn.disabled = true;
                        input.addEventListener('input', () => { DOM.modalSaveBtn.disabled = input.value.toLowerCase() !== 'confirm'; });
                    }
                } else {
                    fields.forEach(field => {
                        let element;
                        switch (field.type) {
                            case 'spacer': element = document.createElement('div'); element.className = 'modal-spacer'; break;
                            case 'nationality':
                                element = document.createElement('div'); element.className = 'input-group';
                                element.innerHTML = `<label>Nationality</label>`;
                                element.appendChild(createRadioGroup('nationality', ['Local', 'Foreigner'], initialValues.nationality));
                                break;
                            case 'radio':
                                element = document.createElement('div'); element.className = 'input-group';
                                if (field.label) element.innerHTML = `<label>${field.label}</label>`;
                                element.appendChild(createRadioGroup(field.id, field.options, initialValues[field.id]));
                                break;
                            case 'documentFields': element = document.createElement('div'); element.id = 'document-fields-container'; break;
                            case 'stepper': element = createModalField(field, initialValues[field.id]); break;
                            case 'row':
                                element = document.createElement('div'); element.className = 'input-row';
                                field.fields.forEach(subField => { element.appendChild(createModalField(subField, initialValues[subField.id])); });
                                break;
                            default: element = createModalField(field, initialValues[field.id] || initialValues.customFees); break;
                        }
                        DOM.modalInputsContainer.appendChild(element);
                    });

                    if (isEdit) {
                        const nationalityRadios = document.querySelectorAll('input[name="nationality"]');
                        nationalityRadios.forEach(radio => radio.addEventListener('change', () => updateDynamicEditFields(initialValues)));
                        updateDynamicEditFields(initialValues);
                    }
                    DOM.modalSaveBtn.textContent = saveButtonText;
                }
                const validate = () => {
                    let isAllValid = true;
                    DOM.modalInputsContainer.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                    DOM.modalInputsContainer.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
                    requiredFields.forEach(fieldId => {
                        const input = DOM.modalInputsContainer.querySelector(`#${fieldId}`);
                        if (input && input.value.trim() === '') {
                            isAllValid = false; input.classList.add('is-invalid');
                            document.getElementById(`${fieldId}-error`).textContent = 'This field is required.';
                        }
                    });
                    validationRules.forEach(rule => {
                        const input = DOM.modalInputsContainer.querySelector(`#${rule.fieldId}`);
                        if (input && !rule.validator(input.value)) {
                            isAllValid = false; input.classList.add('is-invalid');
                            document.getElementById(`${rule.fieldId}-error`).textContent = rule.message;
                        }
                    });
                    DOM.modalSaveBtn.disabled = !isAllValid;
                };

                if (requiredFields.length > 0 || validationRules.length > 0) {
                    currentValidationHandler = validate;
                    DOM.modalInputsContainer.addEventListener('input', currentValidationHandler);
                    validate();
                } else if (!isDelete) {
                    DOM.modalSaveBtn.disabled = false;
                }
                state.currentModalCallback = onSave;
                state.currentModalCancelCallback = onCancel;
                DOM.modalOverlay.classList.add('show');
                DOM.modalInputsContainer.querySelector('input, button')?.focus();
            }

            function hideModal() {
                DOM.modalOverlay.classList.remove('show');
                state.currentModalCallback = null;
                state.currentModalCancelCallback = null;
                state.currentlyEditingTenantId = null;
                if (currentValidationHandler) {
                    DOM.modalInputsContainer.removeEventListener('input', currentValidationHandler);
                    currentValidationHandler = null;
                }
                DOM.modalCancelBtn.style.display = 'inline-block';
                state.isModalOpen = false;
            }

            function showError(message) {
                showModal({ title: "Error", isConfirmation: true, confirmationText: message, saveButtonText: "Close", onSave: hideModal });
                DOM.modalCancelBtn.style.display = 'none';
            }

            function createModalField(field, initialValue = '') {
                const group = document.createElement('div');
                group.className = 'input-group';
                if (field.type === 'stepper') {
                    group.innerHTML = `<label>${field.label}</label>`;
                    const container = document.createElement('div'); container.className = 'stepper-container';
                    const input = `<input type="number" class="modal-input" id="${field.id}" value="${initialValue || 0}" min="0">`;
                    const btns = `<div class="stepper-btns"><button type="button" class="stepper-btn up-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg></button><button type="button" class="stepper-btn down-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></button></div>`;
                    container.innerHTML = input + btns;
                    group.appendChild(container);
                } else if (field.type === 'customFees') {
                    group.innerHTML = `<div class="input-group-header"><label for="${field.id}">${field.label}</label><button type="button" id="add-fee-btn">+ add fee</button></div>`;
                    const feesContainer = document.createElement('div'); feesContainer.id = 'fee-input-container';
                    const fees = Array.isArray(initialValue) ? initialValue : [];
                    if (fees.length === 0) {
                        feesContainer.appendChild(createFeeInput({}, true));
                    } else {
                        fees.forEach((f, i) => feesContainer.appendChild(createFeeInput(f, i === 0)));
                    }
                    group.appendChild(feesContainer);
                } else {
                    group.innerHTML = `<label for="${field.id}">${field.label}</label><input type="${field.type || 'text'}" class="modal-input" id="${field.id}" value="${initialValue === null ? '' : initialValue}" placeholder="${field.placeholder || ''}" ${field.type === 'number' ? 'min="0"' : ''}><div class="invalid-feedback" id="${field.id}-error"></div>`;
                }
                return group;
            }

            function createRadioGroup(name, options, selectedValue) {
                const group = document.createElement('div'); group.className = 'radio-group';
                options.forEach(option => {
                    const label = document.createElement('label');
                    const input = document.createElement('input'); input.type = 'radio'; input.name = name; input.value = option;
                    if (option === selectedValue || (!selectedValue && option === options[0])) input.checked = true;
                    label.append(input, ` ${option}`);
                    group.appendChild(label);
                });
                return group;
            }

            function createVehicleInput(value = '', isFirst = false) {
                const container = document.createElement('div'); container.className = 'vehicle-input-group';
                const removeButtonHTML = isFirst ? '' : `<button type="button" class="remove-vehicle-btn">&times;</button>`;
                container.innerHTML = `<input type="text" class="modal-input vehicle-input" value="${value}" placeholder="">${removeButtonHTML}`;
                return container;
            }

            function createFeeInput(fee = {}, isFirst = false) {
                const container = document.createElement('div'); container.className = 'fee-input-group';
                const pinIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>`;
                container.innerHTML = `
                    <input type="text" class="modal-input fee-desc-input" value="${fee.description || ''}" placeholder="Detail ( e.g. Cleaning )">
                    <input type="number" class="modal-input fee-amount-input" value="${fee.amount || ''}" placeholder="USD" min="0">
                    <button type="button" class="pin-fee-btn ${fee.isPinned ? 'active' : ''}" title="Pin to persist next month">${pinIcon}</button>
                    <button type="button" class="remove-fee-btn">&times;</button>
                `;
                return container;
            }

            function updateDynamicEditFields(initialValues) {
                const docContainer = document.getElementById('document-fields-container');
                if (!docContainer) return;
                const selectedNationality = document.querySelector('input[name="nationality"]:checked').value;
                docContainer.innerHTML = '';
                if (selectedNationality === 'Local') {
                    docContainer.appendChild(createModalField({ id: 'idExpiry', label: 'ID Expiry', type: 'date' }, initialValues.idExpiry || ''));
                } else {
                    docContainer.appendChild(createModalField({ id: 'passportExpiry', label: 'Passport Ex', type: 'date' }, initialValues.passportExpiry || ''));
                    docContainer.appendChild(createModalField({ id: 'visaExpiry', label: 'Visa Ex', type: 'date' }, initialValues.visaExpiry || ''));
                }
            }

            function handleAddSectionClick() {
                showModal({
                    title: 'Add New Section',
                    fields: [{ id: 'sectionName', label: 'Section Name', placeholder: "e.g., 'Floor 2'" }],
                    requiredFields: ['sectionName'],
                    onSave: (values) => {
                        const newSection = { id: state.nextSectionId++, name: values.sectionName, tenants: [] };
                        state.sections.push(newSection);
                        render();
                        sendActionToServer('ADD_SECTION', { id: newSection.id, name: newSection.name });
                    }
                });
            }

            function handleSetRateClick() {
                showModal({
                    title: 'Global Rates',
                    fields: [
                        { id: 'electricity', label: 'Electricity Rate ( per Kwh )', type: 'number' },
                        { id: 'water', label: 'Water Rate ( per Pax )', type: 'number' },
                        { id: 'parking', label: 'Parking Rate ( per vehicle )', type: 'number' },
                        { id: 'lateFee', label: 'Late Fee ( % of Rent )', type: 'number' },
                    ],
                    initialValues: state.rates,
                    requiredFields: ['electricity', 'water', 'parking'],
                    onSave: (newRates) => {
                        state.rates.electricity = Math.max(0, parseFloat(newRates.electricity)) || 0;
                        state.rates.water = Math.max(0, parseFloat(newRates.water)) || 0;
                        state.rates.parking = Math.max(0, parseFloat(newRates.parking)) || 0;
                        state.rates.lateFee = Math.max(0, parseFloat(newRates.lateFee)) || 0;
                        render();
                        sendActionToServer('UPDATE_RATES', state.rates);
                    }
                });
            }

            function handleAddUnitClick(sectionId) {
                const section = state.sections.find(s => s.id === sectionId);
                if (!section) return;
                showModal({
                    title: `Add Unit to ${section.name}`,
                    fields: [{ id: 'unitNumber', label: 'Unit Number', placeholder: "e.g., '101' or 'A-01'" }],
                    requiredFields: ['unitNumber'],
                    onSave: (values) => {
                        const newTenant = { ...state.defaultTenantState, id: state.nextTenantId++, unit: values.unitNumber, paymentHistory: [], sectionId: section.id };
                        section.tenants.push(newTenant);
                        render();
                        sendActionToServer('ADD_TENANT', newTenant);
                    }
                });
            }

            function handlePaidClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                const { totalBilling, other, lateFee, parkingBilling } = getBillingInfo(tenant);
                showModal({
                    title: "Confirm Payment",
                    isConfirmation: true,
                    confirmationText: `Mark payment for ${tenant.name} (Unit ${tenant.unit}) as paid? This will advance the billing date and reset usage meters.`,
                    onSave: () => {
                        const elecUsage = (tenant.elecCurrent || 0) - (tenant.elecPrev || 0);
                        const waterPax = tenant.waterPax || 0;
                        const historyEntry = {
                            billingDate: tenant.currentBillingDate,
                            paidOn: new Date().toISOString().split('T')[0],
                            elecUsage: `${elecUsage} Kwh`,
                            waterPax: waterPax,
                            rent: parseFloat(tenant.rent || 0),
                            other: other,
                            customFees: tenant.customFees ? JSON.parse(JSON.stringify(tenant.customFees)) : [],
                            parking: parkingBilling,
                            lateFee: lateFee,
                            totalPaid: totalBilling
                        };
                        if (!tenant.paymentHistory) tenant.paymentHistory = [];
                        tenant.paymentHistory.push(historyEntry);
                        
                        const nextMonthFees = (tenant.customFees || []).filter(f => f.isPinned);
                        const nextMonthOther = nextMonthFees.reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
                        Object.assign(tenant, {
                            currentBillingDate: calculateNextBillingDate(tenant.currentBillingDate),
                            elecPrev: tenant.elecCurrent,
                            elecCurrent: "",
                            other: nextMonthOther,
                            customFees: nextMonthFees,
                            hasGeneratedInvoice: false
                        });
                        render();
                        sendActionToServer('UPDATE_TENANT', tenant);
                    }
                });
            }

            function handleBillClick(tenantId) {
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                let initialCustomFees = [];
                if (Array.isArray(tenant.customFees) && tenant.customFees.length > 0) {
                    initialCustomFees = tenant.customFees;
                } else if (tenant.other && tenant.other > 0) {
                      initialCustomFees = [{ description: "Miscellaneous", amount: tenant.other, isPinned: false }];
                }
                showModal({
                    title: `Unit ${tenant.unit} : ${tenant.name}`,
                    fields: [
                        { id: 'elecCurrent', label: `Electricity New ( Kwh ) - Prev: ${tenant.elecPrev || 0}`, type: 'number' },
                        { type: 'row', fields: [ { id: 'waterPax', label: 'Water ( Pax )', type: 'stepper' }, { id: 'vehicles', label: 'Vehicle Count', type: 'stepper' } ]},
                        { id: 'customFees', label: 'Other Fees', type: 'customFees' },
                    ],
                    initialValues: { ...tenant, customFees: initialCustomFees, vehicles: (typeof tenant.vehicles === 'number' ? tenant.vehicles : 0), waterPax: (typeof tenant.waterPax === 'number' ? tenant.waterPax : 0) },
                    requiredFields: ['elecCurrent'],
                    validationRules: [ { fieldId: 'elecCurrent', validator: val => parseFloat(val) >= parseFloat(tenant.elecPrev || 0), message: `New reading cannot be less than previous (${tenant.elecPrev || 0}).` } ],
                    onSave: (newReadings) => {
                        tenant.elecCurrent = parseFloat(newReadings.elecCurrent) || tenant.elecPrev;
                        if (newReadings.customFees) {
                            tenant.customFees = newReadings.customFees;
                            tenant.other = tenant.customFees.reduce((sum, fee) => sum + (parseFloat(fee.amount) || 0), 0);
                        } else {
                            tenant.customFees = []; tenant.other = 0;
                        }
                        tenant.vehicles = parseInt(newReadings.vehicles) || 0;
                        tenant.waterPax = parseInt(newReadings.waterPax) || 0;
                        render();
                        sendActionToServer('UPDATE_TENANT', tenant);
                    }
                });
            }

            function handleHistoryClick(tenantId) {
                const allTenants = [...state.sections.flatMap(s => s.tenants), ...state.archivedTenants];
                const tenant = allTenants.find(t => t.id === tenantId);
                if (!tenant?.paymentHistory?.length) return;
                const historyRows = [...tenant.paymentHistory].reverse().map(entry => `<tr><td>${formatDate(entry.paidOn)}</td><td>${entry.elecUsage}</td><td>${entry.waterPax || 0}</td><td>${(entry.rent || 0).toFixed(2)}</td><td>${(entry.other || 0).toFixed(2)}</td><td>${(entry.parking || 0).toFixed(2)}</td><td><strong>${(entry.totalPaid || 0).toFixed(2)}</strong></td></tr>`).join('');
                const historyHtml = `<style>.history-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; table-layout: fixed; } .history-table th, .history-table td { padding: 8px 6px; border: 1px solid var(--border-color); text-align: right; word-wrap: break-word; } .history-table th:first-child, .history-table td:first-child { text-align: left; width: 80px;} .history-table th { background-color: #f8f9fa; font-weight: 500; }</style><table class="history-table"><thead><tr><th>Paid Date</th><th>Elec.</th><th>Pax</th><th>Rent</th><th>Other</th><th>Parking</th><th>Total</th></tr></thead><tbody>${historyRows}</tbody></table>`;
                showModal({ title: `Payment History: ${tenant.name}`, isConfirmation: true, confirmationText: historyHtml, saveButtonText: "Close", onSave: hideModal, isHistory: true });
                DOM.modalCancelBtn.style.display = 'none';
            }

            function handleEndLeaseClick(tenantId) {
                const { tenant, section } = findTenant(tenantId);
                if (!tenant) return;
                showModal({
                    title: `End Lease for ${tenant.name}?`,
                    isConfirmation: true, isDelete: true,
                    confirmationText: "This will move the tenant to the archive. All their data will be saved for historical records, and the unit will be freed up. To proceed, type 'confirm' below.",
                    onSave: () => {
                        const tenantIndex = section.tenants.findIndex(t => t.id === tenantId);
                        if (tenantIndex > -1) {
                            const [archivedTenant] = section.tenants.splice(tenantIndex, 1);
                            archivedTenant.currentBillingDate = "";
                            state.archivedTenants.push(archivedTenant);
                        }
                        render();
                        sendActionToServer('ARCHIVE_TENANT', { tenantId });
                    }
                });
            }

            function handleDeleteUnitEntirely(tenantId) {
                const { tenant, section } = findTenant(tenantId);
                if (!tenant || !section) return;
                showModal({
                    title: `Delete Unit ${tenant.unit} Permanently?`,
                    isConfirmation: true, isDelete: true,
                    confirmationText: `This will permanently delete Unit ${tenant.unit} and all its data from active records. This action cannot be undone. To proceed, type 'confirm' below.`,
                    onSave: () => {
                        section.tenants = section.tenants.filter(t => t.id !== tenantId);
                        render();
                        sendActionToServer('DELETE_TENANT', { tenantId });
                    }
                });
            }

            function handleDeleteSection(sectionId) {
                const section = state.sections.find(s => s.id === sectionId);
                if (!section) return;
                showModal({
                    title: `Delete Section "${section.name}"?`,
                    isConfirmation: true, isDelete: true,
                    confirmationText: `This will permanently delete the section "${section.name}" and all units within it. This action cannot be undone. To proceed, type 'confirm' below.`,
                    onSave: () => {
                        state.sections = state.sections.filter(s => s.id !== sectionId);
                        render();
                        sendActionToServer('DELETE_SECTION', { sectionId });
                    }
                });
            }

            function handleModalSave() {
                if (!state.currentModalCallback) { hideModal(); return; }
                const values = {};
                DOM.modalInputsContainer.querySelectorAll('input:not(.vehicle-input):not(.fee-desc-input):not(.fee-amount-input)').forEach(input => {
                    if (input.type === 'radio') { if (input.checked) values[input.name] = input.value; } else { values[input.id] = input.value; }
                });
                
                const vehicleContainer = DOM.modalInputsContainer.querySelector('#vehicle-input-container');
                if (vehicleContainer) {
                    values.vehicles = Array.from(vehicleContainer.querySelectorAll('.vehicle-input')).map(input => input.value.trim()).filter(Boolean);
                }
                
                const feeContainer = DOM.modalInputsContainer.querySelector('#fee-input-container');
                if (feeContainer) {
                    values.customFees = [];
                    const rows = feeContainer.querySelectorAll('.fee-input-group');
                    rows.forEach(row => {
                          const desc = row.querySelector('.fee-desc-input').value.trim();
                          const amount = parseFloat(row.querySelector('.fee-amount-input').value.trim());
                          const isPinned = row.querySelector('.pin-fee-btn').classList.contains('active');
                          if (desc && !isNaN(amount)) values.customFees.push({ description: desc, amount: amount, isPinned: isPinned });
                    });
                }
                
                const result = state.currentModalCallback(values);
                if (result !== false && !(result && typeof result.then === 'function')) hideModal();
            }

            function handleModalRenew() {
                const tenantId = state.currentlyEditingTenantId;
                if (!tenantId) return;
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                const originalLeaseData = { leaseStart: tenant.leaseStart, leaseEnd: tenant.leaseEnd, tenure: tenant.tenure, currentBillingDate: tenant.currentBillingDate };
                showModal({
                    title: "Confirm Renewal",
                    isConfirmation: true,
                    confirmationText: "Are you sure you want to renew this lease? This will clear the current lease start, tenure, and billing date fields, allowing you to enter new ones.",
                    onSave: () => {
                        Object.assign(tenant, { leaseStart: '', tenure: '', currentBillingDate: '', leaseEnd: '' });
                        handleEditClick(tenantId, () => {
                            const { tenant: tenantToRestore } = findTenant(tenantId);
                            if (tenantToRestore) {
                                Object.assign(tenantToRestore, originalLeaseData);
                                render();
                            }
                        });
                        return false;
                    },
                    onCancel: () => { handleEditClick(tenantId); return false; },
                });
            }

            function handleEditClick(tenantId, onCancelOverride) {
                state.currentlyEditingTenantId = tenantId;
                const { tenant } = findTenant(tenantId);
                if (!tenant) return;
                const formValues = { ...tenant };
                ['leaseStart', 'idExpiry', 'passportExpiry', 'visaExpiry', 'currentBillingDate'].forEach(field => {
                    if (formValues[field]) formValues[field] = sanitizeDateString(formValues[field]);
                });

                showModal({
                    isEdit: true,
                    title: `Edit: ${tenant.name || `Unit ${tenant.unit}`}`,
                    fields: [
                        { id: 'nationality', type: 'nationality' },
                        { id: 'name', label: 'Tenant Name' },
                        { id: 'leaseStart', label: 'Lease Start', type: 'date' },
                        { id: 'tenure', label: 'Tenure ( in months )', type: 'number' },
                        { id: 'rent', label: 'Rent ( USD )', type: 'number' },
                        { type: 'spacer' },
                        { id: 'phone', label: 'Phone' },
                        { id: 'documentFields', type: 'documentFields' },
                        { type: 'spacer' },
                        { id: 'unit', label: 'Unit Number' },
                        { id: 'currentBillingDate', label: 'Billing Date', type: 'date' },
                        { id: 'elecPrev', label: 'Electricity Previous ( Kwh )', type: 'number' },
                    ],
                    initialValues: formValues,
                    requiredFields: ['name', 'leaseStart', 'tenure', 'rent'],
                    validationRules: [ { fieldId: 'rent', validator: (val) => parseFloat(val) >= 0, message: 'Rent cannot be negative.' } ],
                    onSave: (newValues) => {
                        if (newValues.leaseStart && newValues.tenure) newValues.leaseEnd = calculateLeaseEndDate(newValues.leaseStart, newValues.tenure);
                        if (newValues.leaseStart !== tenant.leaseStart && (!tenant.paymentHistory || tenant.paymentHistory.length === 0)) newValues.currentBillingDate = calculateFirstBillingDate(newValues.leaseStart);
                        if (newValues.nationality === 'Local') { Object.assign(newValues, { passportExpiry: '', visaExpiry: '' }); } else { newValues.idExpiry = ''; }
                        Object.assign(tenant, newValues);
                        render();
                        sendActionToServer('UPDATE_TENANT', tenant);
                    },
                    onCancel: onCancelOverride
                });
            }

            function handleLogin() {
                const pinInput = DOM.loginPin.value.trim();
                if (!pinInput && !state.pin) {
                    DOM.loginError.textContent = "Please enter a PIN";
                    DOM.loginError.style.display = 'block';
                    return;
                }
                
                if (pinInput) state.pin = pinInput;
                
                DOM.loginBtn.textContent = "Verifying...";
                DOM.loginBtn.disabled = true;
                DOM.loginError.style.display = 'none';

                // Attempt to load data to verify PIN
                loadDataFromSheet().then(() => {
                    if (state.isAuthenticated) {
                        DOM.loginBtn.textContent = "Unlock Application";
                        DOM.loginBtn.disabled = false;
                        DOM.loginPin.value = "";
                    } else {
                        // Reset if failed
                        DOM.loginBtn.textContent = "Unlock Application";
                        DOM.loginBtn.disabled = false;
                    }
                });
            }

            function init() {
                cacheDOMElements();
                
                // Login Event Listeners
                DOM.loginBtn.addEventListener('click', handleLogin);
                DOM.loginPin.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });

                DOM.addSectionBtn.textContent = 'Loading...';
                DOM.addSectionBtn.disabled = true;

                // Check for saved PIN and try to auto-login
                if (state.pin) {
                    handleLogin();
                } else {
                    // Just ensure UI is ready, wait for user input
                    DOM.addSectionBtn.textContent = '+ add section';
                    DOM.addSectionBtn.disabled = false;
                }

                setInterval(loadDataFromSheet, SYNC_INTERVAL);

                document.body.addEventListener('click', (event) => {
                    const target = event.target;
                    const tenantItem = target.closest('.tenant-item');
                    const tenantId = tenantItem ? parseInt(tenantItem.dataset.tenantId, 10) : null;
                    const actionMap = {
                        'tenant-summary': () => { state.currentlyExpandedTenantId = (state.currentlyExpandedTenantId === tenantId) ? null : tenantId; render(); },
                        'edt-btn': () => handleEditClick(tenantId),
                        'paid-btn': () => handlePaidClick(tenantId),
                        'bill-btn': () => handleBillClick(tenantId),
                        'dlt-btn': () => handleEndLeaseClick(tenantId),
                        'history-btn': () => handleHistoryClick(tenantId),
                    };
                    for (const cls in actionMap) {
                        if (target.classList.contains(cls) || target.closest(`.${cls}`)) { actionMap[cls](); return; }
                    }
                });

                DOM.calendarGrid.addEventListener('click', (event) => {
                    const dayCell = event.target.closest('.calendar-day[data-day]');
                    if (dayCell) handleDayClick(parseInt(dayCell.dataset.day, 10), dayCell.dataset.type);
                });

                document.body.addEventListener('contextmenu', (event) => {
                    if (window.innerWidth <= 600) { event.preventDefault(); return; }
                    DOM.contextMenu.style.display = 'none';
                    const target = event.target;
                    const tenantSummary = target.closest('.tenant-summary');
                    const sectionHeader = target.closest('.floor-header');

                    if (tenantSummary) {
                        event.preventDefault();
                        const tenantId = parseInt(tenantSummary.closest('.tenant-item').dataset.tenantId, 10);
                        const { tenant } = findTenant(tenantId);
                        if (!tenant) return;
                        const statusInfo = getStatusInfo(tenant);
                        const menuItems = [];
                        if (statusInfo.status === 'billing' || statusInfo.status === 'overdue') menuItems.push({ label: 'Generate Invoice', action: 'generate-invoice', id: tenantId });
                        menuItems.push({ label: 'Generate Envelop', action: 'generate-envelop', id: tenantId });
                        menuItems.push({ type: 'divider' });
                        menuItems.push({ label: 'Delete Unit', action: 'delete-unit-permanently', id: tenantId });
                        showContextMenu(event.pageX, event.pageY, menuItems);
                    } else if (sectionHeader) {
                        event.preventDefault();
                        const sectionId = parseInt(sectionHeader.closest('.floor-container').dataset.sectionId, 10);
                        const menuItems = [ { label: 'Add Unit', action: 'add-unit', id: sectionId }, { label: 'Delete Section', action: 'delete-section', id: sectionId } ];
                        showContextMenu(event.pageX, event.pageY, menuItems);
                    } else if (target.id === 'overview-header') {
                        event.preventDefault();
                        const menuItems = [ { label: 'Download Report', action: 'download-report' }, { label: 'Edit Expenses', action: 'edit-expenses' } ];
                        showContextMenu(event.pageX, event.pageY, menuItems);
                    }
                });

                function showContextMenu(x, y, items) {
                    DOM.contextMenu.innerHTML = '';
                    items.forEach(item => {
                        if (item.type === 'divider') {
                            DOM.contextMenu.appendChild(document.createElement('div')).className = 'context-menu-divider'; return;
                        }
                        const menuItem = document.createElement('div');
                        menuItem.className = 'context-menu-item';
                        menuItem.textContent = item.label;
                        menuItem.dataset.action = item.action;
                        if (item.id) menuItem.dataset.id = item.id;
                        DOM.contextMenu.appendChild(menuItem);
                    });
                    DOM.contextMenu.style.top = `${y}px`;
                    DOM.contextMenu.style.left = `${x}px`;
                    DOM.contextMenu.style.display = 'block';
                }

                DOM.contextMenu.addEventListener('click', (event) => {
                    const target = event.target.closest('.context-menu-item');
                    if (!target) return;
                    const { action, id } = target.dataset;
                    const parsedId = id ? parseInt(id, 10) : null;
                    const actionMap = {
                        'edit-expenses': handleEditExpensesClick,
                        'delete-section': handleDeleteSection,
                        'generate-invoice': handlePrintReceiptClick,
                        'generate-envelop': handleGenerateEnvelopClick,
                        'delete-unit-permanently': handleDeleteUnitEntirely,
                        'download-report': handleDownloadReportClick,
                        'add-unit': handleAddUnitClick,
                    };
                    if (actionMap[action]) actionMap[action](parsedId);
                    DOM.contextMenu.style.display = 'none';
                });

                function handleEditExpensesClick() {
                    const date = state.calendarDate;
                    const expenseKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    const initialValues = state.expenses[expenseKey] || { salary: 0, maintenance: 0, consumptionCost: 0, other: 0 };
                    showModal({
                        title: `Edit Expenses for ${date.toLocaleString('en-US', { month: 'long', year: 'numeric' })}`,
                        fields: [
                            { id: 'salary', label: 'Employee Salary (USD)', type: 'number' },
                            { id: 'maintenance', label: 'Maintenance (USD)', type: 'number' },
                            { id: 'consumptionCost', label: 'Consumption Cost (USD)', type: 'number' },
                            { id: 'other', label: 'Other (USD)', type: 'number' },
                        ],
                        initialValues: initialValues,
                        onSave: (values) => {
                            const newValues = {
                                salary: parseFloat(values.salary) || 0,
                                maintenance: parseFloat(values.maintenance) || 0,
                                consumptionCost: parseFloat(values.consumptionCost) || 0,
                                other: parseFloat(values.other) || 0,
                            };
                            state.expenses[expenseKey] = newValues;
                            renderOverview();
                            sendActionToServer('UPDATE_EXPENSES', { key: expenseKey, values: newValues });
                        }
                    });
                }

                function handleDayClick(day, type) {
                    const events = state.tempCalendarData[type]?.[day] || [];
                    if (events.length === 0) return;
                    let totalAmount = 0;
                    let title = type === 'billing' ? "Scheduled Bills" : "Payments Received";
                    let detailsHtml = events.map(item => {
                        if (type === 'billing') {
                            const { tenant } = item;
                            const { totalBilling } = getBillingInfo(tenant);
                            totalAmount += totalBilling;
                            return `<div class="day-detail-item"><span>Unit ${tenant.unit} (${tenant.name})</span><span>${totalBilling.toFixed(2)} USD</span></div>`;
                        } else {
                            const { tenant, entry } = item;
                            totalAmount += entry.totalPaid;
                            return `<div class="day-detail-item"><span>Unit ${tenant.unit} (${tenant.name})</span><span>${entry.totalPaid.toFixed(2)} USD</span></div>`;
                        }
                    }).join('');
                    const fullHtml = `<style>.day-detail-item { display: flex; justify-content: space-between; padding: 0.5rem 0; color: #495057; border-top: 1px solid var(--border-color); } .day-detail-item:first-child { border-top: none; } .day-detail-total { display: flex; justify-content: space-between; padding-top: 1rem; margin-top: 0.5rem; border-top: 2px solid #495057; font-weight: 600; font-size: 1.1rem; color: #495057; }</style><div class="day-details-container">${detailsHtml}</div><div class="day-detail-total"><span>Total</span><span>${totalAmount.toFixed(2)} USD</span></div>`;
                    showModal({ title, isConfirmation: true, confirmationText: fullHtml, saveButtonText: "Close", onSave: hideModal });
                    DOM.modalCancelBtn.style.display = 'none';
                }

                function handleDownloadReportClick() {
                    const today = new Date();
                    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    showModal({
                        title: 'Select Month for Report',
                        fields: [ { id: 'reportMonth', label: 'Report Month', type: 'month' } ],
                        initialValues: { reportMonth: currentMonth },
                        saveButtonText: 'Proceed',
                        onSave: async (values) => {
                            const month = values.reportMonth;
                            if (!month) { showError("Please select a month."); return false; }
                            const saveBtn = document.getElementById('modal-save-btn');
                            saveBtn.disabled = true; saveBtn.textContent = 'Generating...';
                            const data = await sendActionToServer('GENERATE_MONTHLY_REPORT', { month });
                            hideModal();
                            if (data && data.url) {
                                showModal({
                                    title: 'Report Ready', isConfirmation: true,
                                    confirmationText: `Your report has been generated. <br/><br/> <a href="${data.url}" target="_blank" rel="noopener noreferrer">Click here to open the Google Sheet</a>`,
                                    saveButtonText: 'Close', onSave: hideModal,
                                });
                                DOM.modalCancelBtn.style.display = 'none';
                            } else {
                                showError("Failed to generate the report. Please try again.");
                            }
                        }
                    });
                }

                function handlePrintReceiptClick(tenantId) {
                    const { tenant } = findTenant(tenantId);
                    if (!tenant) return;
                    showModal({
                        title: "Select Language",
                        fields: [ { id: 'language', type: 'radio', options: ['English', 'Khmer'] } ],
                        initialValues: { language: 'English' },
                        saveButtonText: "Generate",
                        onSave: async (values) => {
                            const saveBtn = document.getElementById('modal-save-btn');
                            saveBtn.disabled = true; saveBtn.textContent = 'Generating...';
                            const billingInfo = getBillingInfo(tenant);
                            const data = await sendActionToServer('GET_INVOICE_NUMBER');
                            const invoiceNumber = (data && data.invoiceNumber) ? data.invoiceNumber : state.invoiceCounter++;
                            const invoiceData = { ...tenant, ...billingInfo, invoiceNumber: invoiceNumber, rates: state.rates, logoUrl: state.logoUrl };
                            const invoiceHTML = createInvoiceHTML(invoiceData, values.language);
                            const newWindow = window.open('', '_blank');
                            newWindow.document.write(invoiceHTML);
                            newWindow.document.close();
                            tenant.hasGeneratedInvoice = true;
                            render();
                            sendActionToServer('UPDATE_TENANT', tenant);
                            hideModal();
                        }
                    });
                }

                function handleGenerateEnvelopClick(tenantId) {
                    const { tenant } = findTenant(tenantId);
                    if (!tenant) return;
                    
                    const envelopData = { ...tenant, logoUrl: state.logoUrl };
                    const envelopHTML = createEnvelopHTML(envelopData);
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(envelopHTML);
                    newWindow.document.close();
                }

                DOM.modalInputsContainer.addEventListener('click', event => {
                    if (event.target.id === 'add-vehicle-btn') {
                        document.getElementById('vehicle-input-container').appendChild(createVehicleInput());
                    } else if (event.target.classList.contains('remove-vehicle-btn')) {
                        event.target.closest('.vehicle-input-group').remove();
                    } else if (event.target.id === 'add-fee-btn') {
                        document.getElementById('fee-input-container').appendChild(createFeeInput());
                    } else if (event.target.classList.contains('remove-fee-btn')) {
                        const feeGroup = event.target.closest('.fee-input-group');
                        const container = document.getElementById('fee-input-container');
                        if (container.firstElementChild === feeGroup) {
                            feeGroup.querySelector('.fee-desc-input').value = '';
                            feeGroup.querySelector('.fee-amount-input').value = '';
                            const pinBtn = feeGroup.querySelector('.pin-fee-btn');
                            if (pinBtn) pinBtn.classList.remove('active');
                        } else { feeGroup.remove(); }
                    } else if (event.target.classList.contains('pin-fee-btn') || event.target.closest('.pin-fee-btn')) {
                        const btn = event.target.classList.contains('pin-fee-btn') ? event.target : event.target.closest('.pin-fee-btn');
                        btn.classList.toggle('active');
                    } else if (event.target.closest('.up-btn')) {
                        const btn = event.target.closest('.up-btn');
                        const input = btn.closest('.stepper-container').querySelector('input');
                        input.value = parseInt(input.value || 0) + 1;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    } else if (event.target.closest('.down-btn')) {
                        const btn = event.target.closest('.down-btn');
                        const input = btn.closest('.stepper-container').querySelector('input');
                        input.value = Math.max(0, parseInt(input.value || 0) - 1);
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });

                DOM.prevMonthBtn.addEventListener('click', () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); render(); });
                DOM.nextMonthBtn.addEventListener('click', () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); render(); });
                window.addEventListener('click', (e) => { if (!DOM.contextMenu.contains(e.target)) { DOM.contextMenu.style.display = 'none'; } });
                DOM.addSectionBtn.addEventListener('click', handleAddSectionClick);
                DOM.setRateBtn.addEventListener('click', handleSetRateClick);
                DOM.modalSaveBtn.addEventListener('click', handleModalSave);
                DOM.modalCancelBtn.addEventListener('click', () => {
                    if (state.currentModalCancelCallback) { if (state.currentModalCancelCallback() !== false) hideModal(); } else { hideModal(); }
                });
                DOM.modalRenewBtn.addEventListener('click', handleModalRenew);
            }

            document.addEventListener('DOMContentLoaded', init);
        })();

        // --- INVOICE GENERATOR (Global) ---
        function createInvoiceHTML(data, language = 'English') {
            const today = new Date();
            const dueDate = new Date(data.currentBillingDate);
            const formattedToday = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
            const formattedDueDate = `${String(dueDate.getDate()).padStart(2, '0')}/${String(dueDate.getMonth() + 1).padStart(2, '0')}/${dueDate.getFullYear()}`;
            const invoiceNumber = String(data.invoiceNumber).padStart(6, '0');

            const translations = {
                'English': { invoice: "INVOICE", dateOfIssue: "Date of issue", dueDate: "Due date", invoiceNumber: "Invoice number", amountDue: "Amount due", billTo: "Bill to", monthlyRent: "Monthly rent", electricity: "Electricity consumption", water: "Water consumption", parkingOther: "Parking & Other Fees", previous: "Previous", current: "Current", usage: "Usage", rate: "Rate", total: "Total", vehicles: "Vehicles", other: "Other", unit: "Unit", scanToPay: "Scan to Pay" },
                'Khmer': { invoice: "", dateOfIssue: "", dueDate: "", invoiceNumber: "", amountDue: "", billTo: "", monthlyRent: "", electricity: "", water: "", parkingOther: " ", previous: "", current: "", usage: "", rate: "", total: "", vehicles: "", other: "", unit: "", scanToPay: "" }
            };
            const t = translations[language] || translations['English'];
            const fontCss = language === 'Khmer' ?
                `<link href="https://fonts.googleapis.com/css2?family=Moul&family=Noto+Serif+Khmer:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Noto Serif Khmer', 'Inter', serif !important; }
                    .invoice-title-area h1, .charge-item h3, .amount-due-label, .qr-text { font-family: 'Moul', cursive !important; font-weight: normal !important; }
                    .apartment-name { font-family: 'Noto Serif Khmer', serif !important; font-weight: 700 !important; font-size: 1.1rem !important; line-height: 1.6; }
                    .amount-due-value { font-family: 'Noto Serif Khmer', serif !important; font-weight: 700 !important; }
                    .invoice-title-area h1 { font-size: 1.6rem !important; letter-spacing: 0 !important; }
                    .charge-item h3 { font-size: 0.8rem !important; padding-bottom: 6px; }
                    .amount-due-label { font-size: 1.1rem; }
                    .amount-due strong { font-family: inherit !important; }
                </style>` : '';

            const logoHTML = data.logoUrl ? `<img src="${data.logoUrl}" alt="Apartment Logo" class="invoice-logo">` : `<div class="logo-placeholder"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>Your Logo</div>`;
            const qrCodeUrl = "https://iili.io/fDUwQ6X.jpg";
            const filler = '<p style="justify-content: flex-end; color: #adb5bd;">-</p>';

            // Helper to generate content
            const generateContent = () => `
                <div class="invoice-content">
                    <header class="invoice-header">
                        <div class="logo-area">${logoHTML}</div>
                        <div class="invoice-title-area">
                            <h1>${t.invoice}</h1>
                            <p>Norkor Thom Apartment<br>St. 464 No. 78 Chamkarmon<br>12311 Toul Tumpoung 1<br>Phnom Penh</p>
                        </div>
                    </header>
                    <section class="tenant-details-grid">
                        <div class="tenant-info">
                            <p><strong>${data.name}</strong></p>
                            <p>${t.unit} ${data.unit}</p>
                            <br>
                            <p><strong>${t.monthlyRent}</strong></p>
                            <p>${Number(data.rent).toFixed(2)} USD</p>
                        </div>
                        <div class="invoice-dates">
                            <p><strong>${t.dateOfIssue}:</strong> ${formattedToday}</p>
                            <p><strong>${t.dueDate}:</strong> ${formattedDueDate}</p>
                        </div>
                        <div class="amount-due">
                            <p>${t.invoiceNumber}: ${invoiceNumber}</p>
                            <strong><span class="amount-due-label">${t.amountDue}:</span> <span class="amount-due-value">${data.totalBilling.toFixed(2)}</span></strong>
                            <span>USD</span>
                        </div>
                    </section>
                    <main class="charges-grid">
                        <div class="charge-item">
                            <h3>${t.electricity}</h3>
                            <p><span>${t.previous}:</span> <span>${data.elecPrev} Kwh</span></p>
                            <p><span>${t.current}:</span> <span>${data.elecCurrent} Kwh</span></p>
                            <p><span>${t.usage}:</span> <span>${data.elecUsage.toFixed(2)} Kwh</span></p>
                            <hr style="border: none; border-top: 1px solid #f1f3f5; margin: 5px 0;">
                            <p><span>${t.rate}:</span> <span>${data.rates.electricity.toFixed(2)} / Kwh</span></p>
                            <p class="total"><span>${t.total}:</span> <span>${data.elecBilling.toFixed(2)} USD</span></p>
                        </div>
                        <div class="charge-item">
                            <h3>${t.water}</h3>
                            <p><span>Pax:</span> <span>${data.waterPax || 0}</span></p>
                            ${filler}
                            ${filler}
                            <hr style="border: none; border-top: 1px solid #f1f3f5; margin: 5px 0;">
                            <p><span>${t.rate}:</span> <span>${data.rates.water.toFixed(2)} / Pax</span></p>
                            <p class="total"><span>${t.total}:</span> <span>${data.waterBilling.toFixed(2)} USD</span></p>
                        </div>
                        <div class="charge-item">
                            <h3>${t.parkingOther}</h3>
                            <p><span>${t.vehicles}:</span> <span>${data.parkingBilling.toFixed(2)} USD</span></p>
                            <p><span>${t.other}:</span> <span>${Number(data.other).toFixed(2)} USD</span></p>
                            ${data.lateFee > 0 ? `<p><span>Late Fee:</span> <span>${Number(data.lateFee).toFixed(2)} USD</span></p>` : filler}
                            <hr style="border: none; border-top: 1px solid transparent; margin: 5px 0;">
                            ${filler}
                            <p class="total"><span>${t.total}:</span> <span>${(data.parkingBilling + Number(data.other) + Number(data.lateFee || 0)).toFixed(2)} USD</span></p>
                        </div>
                    </main>
                </div>
            `;

            return `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Invoice - ${invoiceNumber}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                ${fontCss}
                <style>
                    :root { --background-color: #555555; --card-background: #ffffff; --primary-text-color: #333; --secondary-text-color: #6c757d; --border-color: #dee2e6; }
                    body { background-color: var(--background-color); font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--primary-text-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
                    .a4-page-container { background-color: var(--card-background); width: 210mm; height: 296mm; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; margin: 0 auto 20px auto; overflow: hidden; position: relative; }
                    .invoice-half { width: 100%; height: 50%; box-sizing: border-box; padding: 10mm 12mm 5mm 12mm; display: flex; justify-content: center; align-items: flex-start; }
                    .qr-container { flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; padding-bottom: 15mm; }
                    .qr-image { max-width: 52.5mm; max-height: 52.5mm; object-fit: contain; display: block; }
                    .invoice-half:last-child { border-bottom: none; }
                    .invoice-content { width: 100%; height: 100%; display: flex; flex-direction: column; }
                    @page { size: A4; margin: 0; }
                    @media print { body { background-color: #fff; padding: 0; margin: 0; display: block; } .a4-page-container { box-shadow: none; width: 100%; height: 100vh; margin: 0; page-break-after: always; } .a4-page-container:last-child { page-break-after: avoid; } }
                    .invoice-header, .tenant-details-grid { display: flex; justify-content: space-between; align-items: flex-start; }
                    .invoice-header { margin-bottom: 10px; }
                    .logo-area .logo-placeholder { width: calc((110px + 2mm) * 0.9); height: 90px; background-color: #f8f9fa; border: 1px dashed var(--border-color); display: flex; justify-content: center; align-items: center; flex-direction: column; color: #adb5bd; font-size: 0.7rem; margin-left: -0.12cm; }
                    .logo-area .logo-placeholder svg { width: 24px; height: 24px; margin-bottom: 4px; }
                    .invoice-logo { width: calc((110px + 2mm) * 0.9); height: 90px; object-fit: fill; margin-left: -0.12cm; }
                    .invoice-title-area { text-align: right; }
                    .invoice-title-area h1 { margin: 0; font-size: 2rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: #adb5bd; line-height: 1; }
                    .invoice-title-area p { margin: 2px 0 0 0; font-size: 0.75rem; color: var(--secondary-text-color); line-height: 1.4; }
                    .tenant-details-grid { margin-bottom: 10px; }
                    .tenant-info p, .invoice-dates p, .amount-due p { margin: 1px 0; font-size: 0.85rem; color: var(--secondary-text-color); }
                    .tenant-info strong, .invoice-dates strong { color: var(--primary-text-color); }
                    .amount-due { text-align: right; }
                    .amount-due strong { display: block; font-size: 1.4rem; font-weight: 700; color: var(--primary-text-color); }
                    .amount-due span { font-size: 1rem; font-weight: 500; color: var(--secondary-text-color); }
                    .charges-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); margin-bottom: auto; }
                    .charge-item h3 { font-size: 0.85rem; font-weight: 600; margin: 0 0 5px 0; padding-bottom: 4px; border-bottom: 1px solid #f1f3f5; color: var(--primary-text-color); }
                    .charge-item p { display: flex; justify-content: space-between; margin: 2px 0; font-size: 0.8rem; color: var(--secondary-text-color); }
                    .charge-item p span:last-child { font-weight: 500; color: var(--primary-text-color); }
                    .charge-item .total { margin-top: 5px; padding-top: 4px; border-top: 1px solid var(--border-color); font-weight: 700; color: var(--primary-text-color); }
                </style>
            </head>
            <body>
                <div class="a4-page-container">
                    <div class="invoice-half">
                        ${generateContent()}
                    </div>
                    <div class="invoice-half">
                        ${generateContent()}
                    </div>
                </div>
                <div class="a4-page-container back-page">
                    <div class="invoice-half qr-container"><img src="${qrCodeUrl}" class="qr-image" alt="Payment QR Code"></div>
                    <div class="invoice-half qr-container"><img src="${qrCodeUrl}" class="qr-image" alt="Payment QR Code"></div>
                </div>
            </body>
            </html>`;
        }
        
        // --- ENVELOP GENERATOR ---
        function createEnvelopHTML(data) {
             const logoHTML = data.logoUrl 
                ? `<img src="${data.logoUrl}" alt="Logo" class="envelop-logo">` 
                : `<div class="envelop-logo-placeholder">LOGO</div>`;

             return `
             <!DOCTYPE html>
             <html lang="en">
             <head>
                <meta charset="UTF-8">
                <title>Print Envelope - ${data.name}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: 'Inter', sans-serif;
                        background-color: #555;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100vh;
                    }
                    
                    @page {
                        size: A4 landscape;
                        margin: 0;
                    }

                    .a4-landscape {
                        width: 297mm;
                        height: 210mm;
                        background: white;
                        position: relative;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        overflow: hidden;
                    }

                    .envelope-area {
                        width: 23.4cm;
                        height: 10.8cm;
                        position: absolute;
                        top: 50%;
                        right: 0; /* Aligned to right */
                        transform: translateY(-50%);
                        padding: 1cm;
                        box-sizing: border-box;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    }

                    .envelope-header {
                        display: flex;
                        align-items: flex-start;
                        gap: 20px;
                        margin-top: -2.2mm;
                    }

                    /* Reusing logic for logo size */
                    .envelop-logo {
                        width: calc((110px + 2mm) * 0.75);
                        height: 75px;
                        object-fit: fill;
                        margin-left: -0.12cm;
                    }
                    
                    .envelop-logo-placeholder {
                        width: calc((110px + 2mm) * 0.75);
                        height: 75px;
                        background: #f8f9fa;
                        border: 1px dashed #ccc;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #aaa;
                        font-size: 0.8rem;
                        margin-left: -0.12cm;
                    }

                    .sender-address {
                        font-size: 0.75rem;
                        color: #555;
                        line-height: 1.4;
                        margin-top: 5px;
                    }
                    
                    .sender-address strong {
                        display: block;
                        font-size: 0.85rem;
                        font-weight: 400;
                        color: #333;
                        margin-bottom: 4px;
                        text-transform: uppercase;
                    }

                    .recipient-container {
                        display: flex;
                        justify-content: flex-end;
                        margin-top: auto;
                        margin-bottom: 2.2mm;
                    }

                    .recipient-box {
                        border: 1px solid #333;
                        padding: 15px 25px;
                        border-radius: 8px;
                        min-width: 200px;
                        background: #fff;
                    }

                    .recipient-box .label {
                        font-size: 0.7rem;
                        text-transform: uppercase;
                        color: #666;
                        letter-spacing: 1px;
                        margin-bottom: 5px;
                    }

                    .recipient-box .room-number {
                        font-size: 1.2rem;
                        font-weight: 400;
                        color: #000;
                        line-height: 1;
                        margin-bottom: 5px;
                    }

                    .recipient-box .tenant-name {
                        font-size: 0.9rem;
                        font-weight: 400;
                        color: #333;
                    }

                    @media print {
                        body { background: none; }
                        .a4-landscape { box-shadow: none; }
                        .envelope-area { border: none; }
                    }
                </style>
             </head>
             <body>
                <div class="a4-landscape">
                    <div class="envelope-area">
                        <div class="envelope-header">
                            ${logoHTML}
                            <div class="sender-address">
                                <strong>Norkor Thom Apartment</strong>
                                St. 464 No. 78 Chamkarmon<br>
                                12311 Toul Tumpoung 1<br>
                                Phnom Penh
                            </div>
                        </div>
                        
                        <div class="recipient-container">
                            <div class="recipient-box">
                                <div class="label">Unit</div>
                                <div class="room-number">${data.unit}</div>
                                <div class="tenant-name">${data.name}</div>
                            </div>
                        </div>
                    </div>
                </div>
             </body>
             </html>`;
        }
    </script>
</body>
</html>

